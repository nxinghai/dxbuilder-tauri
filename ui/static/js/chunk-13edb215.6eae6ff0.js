(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-13edb215"],{"0d4b":function(e,t,n){"use strict";n.r(t);var a=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"erbox",attrs:{"element-loading-text":"拼命加载中","element-loading-spinner":"el-icon-loading","element-loading-background":"rgba(0, 0, 0, 0.8)"}},[n("div",{staticClass:"container",staticStyle:{flex:"1"},attrs:{id:"container"}}),n("div",{staticClass:"minimapbox"},[n("div",{attrs:{id:"minimap"}}),n("div",{staticClass:"btnbox"},[n("el-popover",{attrs:{placement:"right",content:"放大(按住ctrl+鼠标滚动)",trigger:"hover","popper-class":"ipop"}},[n("i",{staticClass:"el-icon-zoom-in",attrs:{slot:"reference"},on:{click:function(t){return e.graphzoom("in")}},slot:"reference"})]),n("el-popover",{attrs:{placement:"right",content:"缩小(按住ctrl+鼠标滚动)",trigger:"hover","popper-class":"ipop"}},[n("i",{staticClass:"el-icon-zoom-out",attrs:{slot:"reference"},on:{click:function(t){return e.graphzoom("out")}},slot:"reference"})])],1)]),n("div",{staticClass:"searchbox"},[n("el-input",{staticStyle:{width:"130px"},attrs:{size:"mini",placeholder:"请输入表代码"},model:{value:e.searchValue,callback:function(t){e.searchValue=t},expression:"searchValue"}}),n("el-button",{attrs:{size:"mini",type:"primary",icon:"el-icon-search"},on:{click:e.search}},[e._v("搜索")]),n("el-button",{attrs:{size:"mini",type:"primary"},on:{click:e.addTableOpen}},[e._v("增加表")])],1),n("edittable",{ref:"edittable"})],1)},o=[],i=n("5530"),r=(n("d3b7"),n("159b"),n("498a"),n("3ca3"),n("ddb0"),n("d81d"),n("99af"),n("bf19"),n("4de4"),n("5728")),c=n("63f2"),s=n("d9ad"),d=n("33e0"),l=n("823b"),u={name:"dber",data:function(){return{projectId:null,container:null,ismove:!1,searchValue:null,dbData:null,loading:!1}},components:{edittable:d["default"]},created:function(){this.loading=!0,this.projectId=this.$route.params.id,this.getDbData()},mounted:function(){this.init()},methods:{getDbData:function(){var e=this;Object(l["f"])(this.projectId).then((function(t){e.dbData=t.data}))},init:function(){this.container=new r["a"]({container:document.getElementById("container"),autoResize:!0,connecting:{router:{name:"er",args:{offset:25,direction:"H"}}},grid:{size:10,visible:!0},scroller:{enabled:!0,pannable:!0},mousewheel:{enabled:!0,modifiers:["ctrl","meta"]},minimap:{enabled:!0,container:document.getElementById("minimap"),width:200,height:150}}),this.initNode()},loadData:function(e){var t=this;Object(s["f"])({projectId:this.$route.params.id}).then((function(n){var a={},o=[],i=0;(n.rows||[]).forEach((function(e){var n=1*e.tableX||i%10*210,r=1*e.tableY||200*parseInt(i/10);a[e.tableCode]={id:e.id,shape:"html",title:e.tableCode+" :"+e.tableName,tableCode:e.tableCode,color:e.color?e.color:"#598cdd",x:n,y:r},null!=e.tableX&&0!=e.tableX.trim().length||t.savePosition({id:e.id,tableX:n,tableY:r}),o.push({id:e.id,code:e.tableCode}),e.tableX||(i+=1)})),Promise.all(o.map((function(e){return Object(c["f"])({tableId:e.id})}))).then((function(t){o.forEach((function(e,n){a[e.code].list=(t[n].rows||[]).map((function(e){return{id:e.id,labelName:e.columnCode+" :"+e.columnName,labelType:e.dataType,isPK:"1"==e.isPrimarykey,isFK:e.keyTableCode,keyTableCode:e.keyTableCode}}))}));var n=[],i=function(e){n.push(a[e]),a[e].list.forEach((function(t,o){t.keyTableCode&&n.push({id:parseInt(o+1e4*Math.random(0,1)),shape:"edge",source:{cell:a[t.keyTableCode].id},target:{cell:a[e].id},zIndex:0})}))};for(var r in a)i(r);e(n)}))}))},initNode:function(){var e=this;this.loadData((function(t){var n=[];t.forEach((function(t){"edge"===t.shape?n.push(e.container.createEdge(Object(i["a"])(Object(i["a"])({},t),{},{connector:{name:"rounded",args:{radius:10}},attrs:{line:{stroke:"#B4BDCF",strokeWidth:1}}}))):n.push(e.container.createNode(e.handleData(t)))})),e.container.resetCells(n),e.container.zoomToFit({padding:10,maxScale:1}),e.nodeMove(),e.loading=!1}))},nodeMove:function(){var e=this;this.container.on("node:mousemove",(function(t){e.ismove||(e.ismove=!0)})),this.container.on("node:dblclick",(function(t){e.editTable(t.node.id)})),this.container.on("node:mouseup",(function(t){e.ismove&&(e.ismove=!1,e.savePosition({id:t.node.id,tableX:t.cell.store.changed.position.x,tableY:t.cell.store.changed.position.y}))}))},handleData:function(e){var t=Object.assign({},e);t.shape="html",t.width=200;var n=28*t.list.length+50;return t.height=n>250?250:n,t.html=this.getHtml(e),t},getHtml:function(e){var t="";(e.list||[]).forEach((function(e,n){t+='<div class="er_self_listitem">\n          <div class="er_self_content">\n            '.concat(e.isPK?'<span class="er_self_pk">PK</span>':"","\n            ").concat(e.isFK?'<span class="er_self_fk">FK</span>':"","\n            ").concat(e.labelName,'\n          </div>\n          <div class="er_self_type">').concat(e.labelType,"</div>\n        </div>")}));var n='<div class="er_self_border"><div class="er_self_box" style="background:'.concat(e.color,'">\n        <div class="er_self_head">').concat(e.title,'</div>\n        <div class="er_self_body">').concat(t,"</div>\n      </div></div>");return n},savePosition:function(e){Object(s["h"])(e).then((function(e){}))},graphzoom:function(e){"in"==e?this.container.zoom(.1):"out"==e&&this.container.zoom(-.1)},search:function(){var e=this;if(this.searchValue){var t=this.container.toJSON(),n=t.cells,a=n.filter((function(t){return"edge"!=t.shape&&t.tableCode==e.searchValue}));if(a.length>0){var o=a[0].position,i=o.x,r=o.y;this.container.scale(1),this.container.scrollToPoint(i,r,{animation:{duration:500}})}else this.$message({showClose:!0,message:"没有查询到表名",type:"warning"})}else this.$message({showClose:!0,message:"请输入表代码",type:"warning"})},editTable:function(e){this.$refs["edittable"]&&this.$refs["edittable"].editTableOpen(this.projectId,e,this.dbData.dbType,"er")},addTableOpen:function(){this.$refs["edittable"]&&this.$refs["edittable"].addTableOpen(this.projectId,"er")}}},p=u,h=(n("14fa"),n("2877")),f=Object(h["a"])(p,a,o,!1,null,null,null);t["default"]=f.exports},"14fa":function(e,t,n){"use strict";n("ef14")},"823b":function(e,t,n){"use strict";n.d(t,"i",(function(){return o})),n.d(t,"f",(function(){return i})),n.d(t,"g",(function(){return r})),n.d(t,"a",(function(){return c})),n.d(t,"l",(function(){return s})),n.d(t,"c",(function(){return d})),n.d(t,"d",(function(){return l})),n.d(t,"k",(function(){return u})),n.d(t,"b",(function(){return p})),n.d(t,"h",(function(){return h})),n.d(t,"m",(function(){return f})),n.d(t,"n",(function(){return b})),n.d(t,"j",(function(){return m})),n.d(t,"e",(function(){return v}));var a=n("b775");function o(e){return Object(a["a"])({url:"/db/project/select",method:"get",params:e})}function i(e){return Object(a["a"])({url:"/db/project/"+e,method:"get"})}function r(e,t){return Object(a["a"])({url:"/db/project/selectAuth/"+e,method:"post",data:t})}function c(e){return Object(a["a"])({url:"/db/project/insert",method:"post",data:e})}function s(e,t){return Object(a["a"])({url:"/db/project/update/"+e,method:"post",data:t})}function d(e){return Object(a["a"])({url:"/db/project/delete/"+e,method:"delete"})}function l(e){return Object(a["a"])({url:"/db/project/delAuth/"+e,method:"delete"})}function u(e,t){return Object(a["a"])({url:"/db/project/transfer/"+e,method:"post",data:t})}function p(e,t){return Object(a["a"])({url:"/db/project/addmember/"+e,method:"post",data:t})}function h(e){return Object(a["a"])({url:"/db/project/import/update?id=".concat(e.id),method:"post",data:e})}function f(e){return Object(a["a"])({url:"/db/project/excel_inport",method:"post",data:e,headers:{"Content-Type":"multipart/form-data"}})}function b(e){return Object(a["a"])({url:"/db/project/importJson",method:"post",data:e,headers:{"Content-Type":"multipart/form-data"}})}function m(e){return Object(a["a"])({url:"/db/project/template_download",method:"get",params:e})}function v(e){return Object(a["a"])({url:"/db/project/export",method:"get",params:e})}},ef14:function(e,t,n){}}]);